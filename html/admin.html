<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Q&A (Anime UI)</title>

<svg style="display:none">
  <symbol id="ic-admin-2" viewBox="0 0 24 24"><path d="M12 2l2.2 4.4L19 7l-3.4 3 .8 4.6L12 12.8 7.6 14.6 8.4 10 5 7l4.8-.6L12 2z"/></symbol>
  <symbol id="ic-send2" viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></symbol>
  <symbol id="ic-copy" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v12h2V3h12V1zM20 5H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h12v14z"/></symbol>
  <symbol id="ic-trash" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></symbol>
  <symbol id="ic-star2" viewBox="0 0 24 24"><path d="M12 17.3L18.2 21l-1.6-6.3L22 9.2l-6.5-.6L12 3 9.5 8.6 3 9.2 7.4 14.7 5.8 21z"/></symbol>
</svg>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700;800&display=swap');

  :root{ --accent1:#7fb8ff; --accent2:#c995ff; }

  body{
    margin:0; font-family: "Nunito", Arial, sans-serif;
    background: url("paper.png") center/cover fixed;
    color:#122033;
    -webkit-font-smoothing:antialiased;
  }

  /* header dạng bong bóng – tròn – trong suốt – glass bubble */
.header{
    margin: 20px auto 10px;
    padding: 18px 28px;
    width: fit-content;

    background: rgba(255,255,255,0.25);
    backdrop-filter: blur(14px) saturate(160%);
    -webkit-backdrop-filter: blur(14px) saturate(160%);

    border-radius: 40px;
    border: 2px solid rgba(255,255,255,0.45);
    
    font-size: 26px;
    font-weight: 800;
    color: #ffffff;
    text-shadow: 0 2px 6px rgba(0,0,0,0.2);

    box-shadow:
      0 6px 20px rgba(255,255,255,0.28),
      inset 0 4px 10px rgba(255,255,255,0.45),
      inset 0 -4px 12px rgba(150,180,255,0.25);

    position: relative;
    overflow: hidden;
}

/* hiệu ứng tráng kính chạy ngang */
.header::after{
    content:'';
    position:absolute;
    top:0; left:-60%;
    width:50%; height:100%;
    background: linear-gradient(
        120deg,
        rgba(255,255,255,0.15),
        rgba(255,255,255,0.55),
        rgba(255,255,255,0.15)
    );
    transform: skewX(-20deg);
    animation: headerShine 3.6s infinite linear;
}

@keyframes headerShine{
    0%{ left:-60%; }
    100%{ left:130%; }
}


  .wrap{ max-width:1000px; margin:20px auto; padding:18px; }

  .controls-row{ display:flex; gap:12px; align-items:center; margin-bottom:12px; }
  .controls-row .btn{ padding:10px 14px; border-radius:12px; border:none; cursor:pointer; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:white; font-weight:700; box-shadow:0 8px 26px rgba(100,120,200,0.12); }

  .list{ display:flex; flex-direction:column; gap:18px; }

  .card{
    background: rgba(255,255,255,0.6);
    border-radius:16px; padding:14px; border:1px solid rgba(255,255,255,0.55);
    box-shadow: 0 12px 28px rgba(50,70,120,0.08); backdrop-filter: blur(8px);
    transition: transform .2s ease, box-shadow .2s ease;
  }
  .card:hover{ transform:translateY(-6px); box-shadow:0 18px 40px rgba(50,70,120,0.14); }

  .row-top{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .qtext{ font-size:18px; font-weight:800; color:#1f3761; }
  .meta{ font-size:13px; color:#5b6b80 }

  textarea{ width:100%; min-height:84px; resize:vertical; padding:10px 12px; border-radius:12px; border:none; font-size:15px; background:rgba(255,255,255,0.9); box-shadow:inset 0 8px 16px rgba(0,0,0,0.06) }

  .card .actions{ margin-top:10px; display:flex; gap:8px; align-items:center; }
  .icon-btn{ padding:8px 10px; border-radius:10px; border:none; cursor:pointer; background:transparent; box-shadow:none; display:inline-flex; align-items:center; gap:8px; color:#1f3761; font-weight:700; }
  .save{ background: linear-gradient(135deg,var(--accent1),var(--accent2)); color:white; border-radius:12px; padding:10px 12px; box-shadow:0 8px 24px rgba(100,120,200,0.12); }

  .note { font-size:13px; color:rgba(20,30,40,0.7); }

  /* new badge for answered */
  .badge-ok{ display:inline-block; padding:6px 8px; background:#b8ffda; color:#0b3d2e; border-radius:10px; font-weight:700; font-size:13px; }

  /* small animated icon for new answer */
  .pulse {
    display:inline-block;
    width:14px; height:14px; border-radius:50%;
    background:linear-gradient(180deg,#ffd1e6,#ffd9ff);
    box-shadow:0 6px 16px rgba(255,150,220,0.2);
    animation: pulse 1.6s infinite;
  }
  @keyframes pulse{ 0%{transform:scale(1)}50%{transform:scale(1.25)}100%{transform:scale(1)} }

  /* responsive */
  @media (max-width:640px){
    .header{font-size:20px}
    .wrap{padding:12px}
  }
</style>
</head>
<body>

<div class="header">Admin — Hòm thư Q&A</div>

<div class="wrap">
  <div class="controls-row">
    <button class="btn" onclick="refreshList()">⟳ Refresh</button>
    <div class="note">Mẹo: bấm "Lưu & Gửi" để trả lời người dùng — họ sẽ nhận ngay nếu đang mở trang.</div>
  </div>

  <div id="list" class="list"></div>
</div>

<script>
/* admin with broadcast + localStorage */
const channel = (typeof BroadcastChannel !== 'undefined') ? new BroadcastChannel('qa_channel') : null;

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`=\/]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[c]); }

function refreshList(){
  const list = document.getElementById('list');
  const data = JSON.parse(localStorage.getItem('qa_data')) || [];
  data.sort((a,b)=>b.id - a.id);
  list.innerHTML = '';
  if(data.length===0){
    list.innerHTML = '<div class="card"><div class="qtext">Không có câu hỏi</div></div>';
    return;
  }
  data.forEach(item=>{
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <div class="row-top">
        <div>
          <div class="qtext">❓ ${escapeHtml(item.text)}</div>
          <div class="meta">ID: ${item.id} · ${escapeHtml(item.time)} ${ item.answer ? ' · <span class="badge-ok">Đã trả lời</span>' : '' }</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:13px;color:#374b6b">From: <b>${escapeHtml(item.fromName || 'Người dùng')}</b></div>
          ${ item.answer ? `<div style="margin-top:8px;color:#455d88;font-weight:700">${escapeHtml(item.answer)}</div>` : `<div style="margin-top:8px;color:#9aa9c9">Chưa có trả lời</div>` }
        </div>
      </div>

      <div style="margin-top:12px">
        <textarea id="ans_${item.id}" placeholder="Nhập trả lời...">${escapeHtml(item.answer || '')}</textarea>

        <div class="actions">
          <button class="save" onclick="saveAndSend(${item.id})"><svg width="16" height="16" style="vertical-align:middle;margin-right:6px"><use href="#ic-send2"></use></svg> Lưu & Gửi</button>
          <button class="icon-btn" onclick="saveOnly(${item.id})"><svg width="16" height="16"><use href="#ic-copy"></use></svg> Chỉ Lưu</button>
          <button class="icon-btn" onclick="deleteQ(${item.id})"><svg width="16" height="16"><use href="#ic-trash"></use></svg> Xóa</button>
        </div>
      </div>
    `;
    list.appendChild(el);
  });
}

/* operations */
function saveOnly(id){
  const data = JSON.parse(localStorage.getItem('qa_data')) || [];
  const idx = data.findIndex(x=>x.id===id);
  if(idx<0) return alert('Không tìm thấy');
  data[idx].answer = document.getElementById('ans_'+id).value.trim();
  localStorage.setItem('qa_data', JSON.stringify(data));
  alert('Đã lưu cục bộ (chưa gửi)');
  refreshList();
}

function saveAndSend(id){
  const data = JSON.parse(localStorage.getItem('qa_data')) || [];
  const idx = data.findIndex(x=>x.id===id);
  if(idx<0) return alert('Không tìm thấy');
  const ans = document.getElementById('ans_'+id).value.trim();
  data[idx].answer = ans;
  data[idx].answeredAt = new Date().toLocaleString();
  localStorage.setItem('qa_data', JSON.stringify(data));

  // broadcast answer
  const payload = { type:'answer', id:id, answer:ans, answeredAt:data[idx].answeredAt };
  try{ if(channel) channel.postMessage(payload); }catch(e){}
  try{ localStorage.setItem('qa_update', Date.now().toString()); }catch(e){}

  alert('Đã gửi trả lời cho người dùng ✓');
  refreshList();
}

function deleteQ(id){
  if(!confirm('Xóa câu hỏi này?')) return;
  let data = JSON.parse(localStorage.getItem('qa_data')) || [];
  data = data.filter(x=>x.id!==id);
  localStorage.setItem('qa_data', JSON.stringify(data));
  refreshList();
}

/* listen to updates from other admin tabs */
if(channel){
  channel.onmessage = ev => {
    // refresh on any event
    refreshList();
  };
}
window.addEventListener('storage', e => {
  if(e.key === 'qa_data' || e.key === 'qa_update') refreshList();
});

// init
refreshList();
</script>

</body>
</html>
